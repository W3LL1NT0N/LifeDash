<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Life Dash v6.2 | Ton</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        :root {
            /* THEME: ZEN LIGHT */
            --bg-body: #ffffff; --bg-surface: #f8f9fa; --border: #e2e8f0;
            --text-main: #1e293b; --text-sec: #64748b;
            --fin: #0ea5e9; --org: #8b5cf6; --ok: #10b981; --warn: #f59e0b; --err: #ef4444; --dark: #0f172a;
            --radius: 6px; --header-h: 56px; --sidebar-w: 280px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Noto Sans', sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 14px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* SCREENS */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; background: var(--bg-body); z-index: 10; }
        .screen.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* SETUP LAYOUT */
        .center-box { margin: auto; width: 100%; max-width: 600px; padding: 2rem; text-align: center; }
        .setup-block { 
            background: #fff; border: 1px solid var(--border); border-radius: 8px; 
            padding: 1.5rem; text-align: left; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 2rem; 
        }
        .block-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; color: var(--dark); }
        .block-desc { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 1rem; line-height: 1.4; }
        
        .field-label { font-size: 0.75rem; font-weight: 700; color: var(--text-sec); text-transform: uppercase; margin-top: 1rem; display: block; }
        .setup-input { width: 100%; padding: 0.8rem; margin-top: 0.3rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.95rem; background: #fff; color: var(--text-main); }
        .tag-list { font-family: monospace; font-size: 0.75rem; background: var(--bg-surface); padding: 0.5rem; border-radius: 4px; color: var(--fin); word-break: break-all; margin-top: 0.5rem; display: block; }

        .btn-full { width: 100%; padding: 0.9rem; background: var(--dark); color: #fff; border: none; border-radius: var(--radius); font-weight: 700; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .btn-link { background: none; border: none; color: var(--text-sec); font-size: 0.85rem; cursor: pointer; text-decoration: underline; margin-top: 1rem; }

        /* DIAGNOSTICS */
        .diag-list { text-align: left; margin-top: 1.5rem; background: var(--bg-surface); padding: 1rem; border-radius: var(--radius); border: 1px solid var(--border); }
        .diag-item { display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem; font-size: 0.9rem; color: var(--text-main); }
        .d-icon { font-size: 1.2rem; display: flex; align-items: center; }
        .d-load { color: var(--fin); animation: spin 1s linear infinite; }
        .d-ok { color: var(--ok); } .d-err { color: var(--err); }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* APP STYLES (Mantidos) */
        header { height: var(--header-h); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; background: rgba(255,255,255,0.95); backdrop-filter: blur(4px); z-index: 20; flex-shrink: 0; }
        .h-title { font-weight: 700; font-size: 1.1rem; }
        .btn-icon { background: transparent; border: none; font-size: 1.4rem; padding: 0.5rem; cursor: pointer; color: var(--text-main); border-radius: 50%; }
        
        aside { position: fixed; top: 0; left: 0; bottom: 0; width: var(--sidebar-w); background: #fff; border-right: 1px solid var(--border); z-index: 50; transform: translateX(-100%); transition: transform 0.25s ease; display: flex; flex-direction: column; padding: 1.5rem; }
        aside.open { transform: translateX(0); }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; }
        .drawer-overlay.open { display: block; }
        
        .nav-btn { background: transparent; border: none; width: 100%; padding: 0.8rem 0; text-align: left; font-size: 1rem; font-weight: 500; color: var(--text-sec); cursor: pointer; display: flex; align-items: center; gap: 1rem; }
        .nav-btn.active { color: var(--dark); font-weight: 700; }
        .nav-group { margin-top: 2rem; font-size: 0.75rem; font-weight: 700; color: #94a3b8; letter-spacing: 0.05em; margin-bottom: 0.5rem; }

        .filters-bar { background: var(--bg-surface); border-bottom: 1px solid var(--border); padding: 0.5rem 1rem; display: none; gap: 0.5rem; flex-wrap: wrap; }
        .filters-bar.open { display: flex; }
        .f-select, .f-search { padding: 0.4rem; border: 1px solid var(--border); border-radius: 20px; font-size: 0.8rem; background: #fff; }
        .f-search { flex: 1; padding: 0.4rem 1rem; min-width: 150px; }

        .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; padding: 1rem; }
        .kpi-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; display: flex; flex-direction: column; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .kpi-fin { border-left: 4px solid var(--fin); } .kpi-org { border-left: 4px solid var(--org); }
        .kpi-val { font-size: 1.25rem; font-weight: 700; font-family: monospace; color: var(--text-main); }
        .kpi-label { font-size: 0.75rem; color: var(--text-sec); font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem; }

        .list-area { flex: 1; overflow-y: auto; padding: 0 1rem 5rem; }
        .list-header { position: sticky; top: 0; background: var(--bg-body); padding: 1rem 0 0.5rem; font-weight: 700; color: var(--text-sec); font-size: 0.85rem; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .row { display: grid; grid-template-columns: 24px 1fr auto; gap: 1rem; padding: 0.85rem 0; border-bottom: 1px solid var(--border); align-items: center; }
        .r-check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border); cursor: pointer; position: relative; }
        .r-check.pendente { border-color: var(--text-sec); } .r-check.concluido { background: var(--ok); border-color: var(--ok); } .r-check.cancelado { border-color: var(--err); }
        .r-check.concluido::after { content:'✓'; color:#fff; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:12px; }
        .r-title { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .r-meta { font-size: 0.75rem; color: var(--text-sec); display: flex; align-items: center; gap: 6px; }
        .r-cat { background: var(--bg-surface); padding: 1px 6px; border-radius: 4px; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; }
        .r-val { font-family: monospace; font-weight: 600; text-align: right; font-size: 0.95rem; }

        .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: var(--dark); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; z-index: 30; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal { background: #fff; width: 90%; max-width: 500px; padding: 1.5rem; border-radius: 12px; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-grp { margin-bottom: 1rem; }

        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
    </style>
</head>
<body>

    <div id="loader"><i class="ph ph-spinner ph-spin" style="font-size: 2.5rem; color: var(--dark);"></i><div id="loader_msg" style="font-weight: 600; color: var(--text-sec);">Processando...</div></div>

    <!-- 1. SETUP SCREEN -->
    <div id="screen_setup" class="screen">
        <div class="center-box">
            <h2 style="margin-bottom: 0.5rem;">Configuração do Sistema</h2>
            <p style="color: var(--text-sec); margin-bottom: 2rem;">Conecte cada formulário à sua respectiva planilha.</p>

            <!-- BLOCO 1: REGISTROS -->
            <div class="setup-block">
                <div class="block-title"><i class="ph ph-database"></i> 1. Base de Registros</div>
                <div class="block-desc">
                    Use tags: TAG_ID, TAG_TITULO, TAG_DATA, TAG_HORA, TAG_VALOR, TAG_CAT, TAG_REC, TAG_STATUS, TAG_DET, TAG_TS, TAG_DEL
                </div>
                
                <span class="field-label">Link do Formulário (Preenchido)</span>
                <input type="text" id="cfg_form_rec" class="setup-input" placeholder="https://docs.google.com/...viewform?...">
                
                <span class="field-label">Link da Planilha (CSV)</span>
                <input type="text" id="cfg_csv_rec" class="setup-input" placeholder="https://docs.google.com/...export?format=csv">
            </div>

            <!-- BLOCO 2: LISTAS -->
            <div class="setup-block">
                <div class="block-title"><i class="ph ph-list-checks"></i> 2. Listas & Token</div>
                <div class="block-desc">
                    Use tags: TAG_ID, TAG_NOME, TAG_TS, TAG_DEL
                </div>
                
                <span class="field-label">Link do Formulário (Preenchido)</span>
                <input type="text" id="cfg_form_cat" class="setup-input" placeholder="https://docs.google.com/...viewform?...">
                
                <span class="field-label">Link da Planilha (CSV)</span>
                <input type="text" id="cfg_csv_cat" class="setup-input" placeholder="https://docs.google.com/...export?format=csv">
            </div>

            <!-- BLOCO 3: LOGS -->
            <div class="setup-block">
                <div class="block-title"><i class="ph ph-scroll"></i> 3. Logs de Segurança</div>
                <div class="block-desc">
                    Use tags: TAG_STATUS, TAG_DATA, TAG_AGENT, TAG_SCREEN, TAG_IP
                </div>
                
                <span class="field-label">Link do Formulário (Preenchido)</span>
                <input type="text" id="cfg_form_log" class="setup-input" placeholder="https://docs.google.com/...viewform?...">
                
                <span class="field-label">Link da Planilha (CSV)</span>
                <input type="text" id="cfg_csv_log" class="setup-input" placeholder="https://docs.google.com/...export?format=csv">
            </div>

            <button class="btn-full" onclick="iniciar_diagnostico_setup()">SALVAR E CONECTAR</button>
            <button class="btn-link" onclick="hard_reset()">⚠️ Limpar Dados / Reiniciar</button>

            <div id="setup_diag" class="diag-list" style="display: none;"></div>
        </div>
    </div>

    <!-- 2. REGISTER SCREEN -->
    <div id="screen_register" class="screen">
        <div class="center-box" style="max-width:400px;">
            <h1><i class="ph ph-shield-plus"></i></h1>
            <h2>Criar Senha Mestra</h2>
            <p style="color:var(--text-sec); margin-bottom:1.5rem;">Defina a senha para criptografar seus dados.</p>
            <input type="password" id="reg_pass" class="setup-input" placeholder="Nova Senha" style="text-align:center; letter-spacing:4px;">
            <input type="password" id="reg_pass_conf" class="setup-input" placeholder="Confirmar" style="text-align:center; letter-spacing:4px;">
            <button class="btn-full" id="btn_criar_token" onclick="registrar_token()">CRIAR E SALVAR</button>
        </div>
    </div>

    <!-- 3. WAIT SCREEN -->
    <div id="screen_wait" class="screen">
        <div class="center-box" style="max-width:400px;">
            <h1 style="color: var(--fin);"><i class="ph ph-arrows-clockwise ph-spin"></i></h1>
            <h2>Sincronizando...</h2>
            <p style="color:var(--text-sec); margin-bottom:1rem;">Aguardando Google Sheets...</p>
            <div id="wait_diag" class="diag-list">
                <div class="diag-item"><div class="d-icon d-ok"><i class="ph ph-check-circle"></i></div><span>Senha enviada</span></div>
                <div class="diag-item"><div class="d-icon d-load"><i class="ph ph-spinner"></i></div><span>Aguardando propagação (<span id="try_count">1</span>)...</span></div>
            </div>
        </div>
    </div>

    <!-- 4. LOGIN SCREEN -->
    <div id="screen_login" class="screen">
        <div class="center-box" style="max-width:400px;">
            <h1 style="margin-bottom: 2rem;"><i class="ph ph-lock-key"></i></h1>
            <h3>Acesso Seguro</h3>
            <input type="password" id="login_pass" class="setup-input" placeholder="Senha" style="text-align: center; letter-spacing: 4px; font-size: 1.2rem;" onkeyup="if(event.key==='Enter') auth()">
            <button class="btn-full" onclick="auth()">ENTRAR</button>
            <p id="login_err" style="color: var(--err); margin-top: 1rem; font-size: 0.8rem;"></p>
            <button class="btn-link" onclick="hard_reset()">Resetar Conexões</button>
        </div>
    </div>

    <!-- 5. APP SCREEN -->
    <div id="screen_app" class="screen">
        <header>
            <button class="btn-icon" onclick="toggle_drawer()"><i class="ph ph-list"></i></button>
            <div class="h-title" id="page_title">Dashboard</div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn-icon" onclick="toggle_filters()"><i class="ph ph-funnel"></i></button>
                <button class="btn-icon" onclick="sincronizar()"><i class="ph ph-cloud-arrow-up"></i></button>
            </div>
        </header>

        <div class="filters-bar" id="filters_bar">
            <input type="text" class="f-search" id="f_search" placeholder="Buscar..." onkeyup="render()">
            <select class="f-select" id="f_period" onchange="render()"><option value="hoje">Hoje</option><option value="ontem">Ontem</option><option value="mes" selected>Este Mês</option><option value="tudo">Tudo</option></select>
            <select class="f-select" id="f_status" onchange="render()"><option value="todos">Status</option><option value="pendente">Pendente</option></select>
            <select class="f-select" id="f_cat" onchange="render()"><option value="todos">Categoria</option></select>
        </div>

        <div class="drawer-overlay" id="drawer_overlay" onclick="toggle_drawer()"></div>
        <aside id="drawer">
            <div style="font-weight:700; font-size:1.2rem; margin-bottom:2rem; display:flex; gap:0.5rem; align-items:center;">
                <i class="ph ph-squares-four"></i> Ton Planner
            </div>
            <button class="nav-btn active" onclick="nav('dashboard')"><i class="ph ph-chart-pie-slice"></i> Dashboard</button>
            <div class="nav-group">REGISTROS</div>
            <button class="nav-btn" onclick="nav('todos')"><i class="ph ph-list-dashes"></i> Todos</button>
            <button class="nav-btn" onclick="nav('fin')"><i class="ph ph-currency-dollar"></i> Financeiro</button>
            <button class="nav-btn" onclick="nav('org')"><i class="ph ph-check-square"></i> Organizacional</button>
            <div class="nav-group">SISTEMA</div>
            <button class="nav-btn" onclick="nav('cats')"><i class="ph ph-tag"></i> Categorias</button>
            <button class="nav-btn" onclick="logout()"><i class="ph ph-sign-out"></i> Sair</button>
        </aside>

        <main style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
            <div id="dash_kpi" class="kpi-row" style="display:none;">
                <div class="kpi-card kpi-fin">
                    <span class="kpi-label">Saldo</span><span class="kpi-val" id="kpi_bal">R$ 0,00</span>
                    <div style="font-size:0.75rem; color:var(--text-sec); display:flex; justify-content:space-between; margin-top:4px;">
                        <span style="color:var(--ok)">Ent: <span id="kpi_in">0</span></span><span style="color:var(--err)">Sai: <span id="kpi_out">0</span></span>
                    </div>
                </div>
                <div class="kpi-card kpi-org">
                    <span class="kpi-label">Tarefas</span><span class="kpi-val" id="kpi_task">0</span>
                    <div style="font-size:0.75rem; color:var(--text-sec); display:flex; justify-content:space-between; margin-top:4px;">
                        <span style="color:var(--warn)">Pend: <span id="kpi_pend">0</span></span><span style="color:var(--ok)">Ok: <span id="kpi_ok">0</span></span>
                    </div>
                </div>
            </div>
            <div class="list-area">
                <div class="list-header"><span id="list_title">Registros</span><span id="list_count">0</span></div>
                <div id="list_content"></div>
            </div>
        </main>
        <div class="fab" onclick="modal_open()"><i class="ph ph-plus"></i></div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modal_overlay">
        <div class="modal">
            <h3 style="margin-bottom:1rem;">Registro</h3>
            <input type="hidden" id="e_id">
            <div class="form-grp"><label>Título</label><input type="text" id="e_titulo" class="setup-input" style="margin:0;"></div>
            <div class="form-grid">
                <div class="form-grp"><label>Data</label><input type="date" id="e_data" class="setup-input" style="margin:0;"></div>
                <div class="form-grp"><label>Hora</label><input type="time" id="e_hora" class="setup-input" style="margin:0;"></div>
            </div>
            <div class="form-grid">
                <div class="form-grp"><label>Valor (Vazio = Org)</label><input type="number" id="e_valor" step="0.01" class="setup-input" style="margin:0;"></div>
                <div class="form-grp"><label>Categoria</label><select id="e_cat" class="setup-input" style="margin:0;"></select></div>
            </div>
            <div class="form-grid">
                <div class="form-grp"><label>Recorrência</label><select id="e_rec" class="setup-input" style="margin:0;"><option value="unica">Única</option><option value="mensal">Mensal</option></select></div>
                <div class="form-grp"><label>Status</label><select id="e_status" class="setup-input" style="margin:0;"><option value="pendente">Pendente</option><option value="concluido">Concluído</option></select></div>
            </div>
            <div class="form-grp"><label>Detalhes</label><textarea id="e_det" class="setup-input" style="margin:0;" rows="2"></textarea></div>
            <div style="display:flex; align-items:center; margin-top:1rem;">
                <button class="btn-link" onclick="del_item()" style="color:var(--err)">Excluir</button>
                <div style="display:flex; gap:1rem;">
                    <button class="btn-link" onclick="modal_close()">Cancelar</button>
                    <button class="btn-full" onclick="save_item()" style="margin:0; width:auto; padding:0.6rem 2rem;">SALVAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === STATE ===
        let CONFIG = {};
        let DATA = { recs: [], cats: [] };
        let QUEUE = [];
        let VIEW = 'dashboard';
        let REMOTE_TOKEN_HASH = null;
        let POLLING_INTERVAL = null;

        window.onload = () => verificar_estado_inicial();
        function show_screen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function show_loader(show, msg) { const l=document.getElementById('loader'); if(show){l.style.display='flex';if(msg)document.getElementById('loader_msg').innerText=msg;}else{l.style.display='none';} }

        // === 1. SETUP LOGIC ===
        function verificar_estado_inicial() {
            const local_conf = localStorage.getItem('ton_config');
            if (local_conf) {
                CONFIG = JSON.parse(local_conf);
                verificar_token_remoto();
            } else {
                show_screen('screen_setup');
            }
        }

        function hard_reset() {
            if(confirm("Isso apagará todas as configurações locais. Tem certeza?")) {
                localStorage.clear();
                location.reload();
            }
        }

        async function iniciar_diagnostico_setup() {
            const area = document.getElementById('setup_diag');
            area.style.display = 'block'; area.innerHTML = '';
            const add_check = (label, st) => {
                const icon = st==='ok'?'<i class="ph ph-check-circle"></i>':(st==='load'?'<i class="ph ph-spinner"></i>':'<i class="ph ph-x-circle"></i>');
                const cls = st==='ok'?'d-ok':(st==='load'?'d-load':'d-err');
                area.innerHTML += `<div class="diag-item"><div class="d-icon ${cls}">${icon}</div><span>${label}</span></div>`;
            };

            const csv_rec = document.getElementById('cfg_csv_rec').value;
            const csv_cat = document.getElementById('cfg_csv_cat').value;
            const csv_log = document.getElementById('cfg_csv_log').value;
            const form_rec = document.getElementById('cfg_form_rec').value;
            const form_cat = document.getElementById('cfg_form_cat').value;
            const form_log = document.getElementById('cfg_form_log').value;

            if(!csv_rec || !csv_cat || !csv_log || !form_rec || !form_cat || !form_log) { alert('Preencha tudo.'); return; }

            const map_rec = { id:'TAG_ID', titulo:'TAG_TITULO', data:'TAG_DATA', hora:'TAG_HORA', valor:'TAG_VALOR', cat:'TAG_CAT', rec:'TAG_REC', status:'TAG_STATUS', det:'TAG_DET', ts:'TAG_TS', del:'TAG_DEL' };
            const map_cat = { id:'TAG_ID', nome:'TAG_NOME', ts:'TAG_TS', del:'TAG_DEL' };
            const map_log = { status:'TAG_STATUS', data:'TAG_DATA', agent:'TAG_AGENT', screen:'TAG_SCREEN', ip:'TAG_IP' };

            const c_rec = parse_link(form_rec, map_rec); add_check('Form Registros', c_rec?'ok':'err');
            const c_cat = parse_link(form_cat, map_cat); add_check('Form Listas', c_cat?'ok':'err');
            const c_log = parse_link(form_log, map_log); add_check('Form Logs', c_log?'ok':'err');

            if(!c_rec || !c_cat || !c_log) return;

            // Test CSV Connection (Listas é o mais importante para Auth)
            add_check('Testando CSV Listas...', 'load');
            try {
                const res = await fetch(csv_cat + '&t=' + Date.now());
                if(res.ok) {
                    area.lastElementChild.innerHTML = `<div class="d-icon d-ok"><i class="ph ph-check-circle"></i></div><span>Conexão CSV OK</span>`;
                    
                    const conf = { 
                        csvs: { rec: csv_rec, cat: csv_cat, log: csv_log },
                        forms: { rec: c_rec, cat: c_cat, log: c_log } 
                    };
                    localStorage.setItem('ton_config', JSON.stringify(conf));
                    CONFIG = conf;
                    setTimeout(() => verificar_token_remoto(), 1000);
                } else throw new Error();
            } catch(e) {
                area.lastElementChild.innerHTML = `<div class="d-icon d-err"><i class="ph ph-x-circle"></i></div><span>Erro CSV: Inacessível</span>`;
            }
        }

        // === 2. AUTH FLOW ===
        async function verificar_token_remoto() {
            try {
                // Fetch from LISTS CSV
                const res = await fetch(CONFIG.csvs.cat + '&t=' + Date.now());
                const txt = await res.text();
                const rows = parse_csv_simple(txt);
                
                let token = null;
                // Procura na planilha de categorias se tem o sys_token
                rows.forEach(r => {
                    const idx = r.indexOf('sys_token');
                    if (idx > -1 && r[idx+1]) token = r[idx+1];
                });

                if (token) {
                    REMOTE_TOKEN_HASH = token;
                    if(POLLING_INTERVAL) clearInterval(POLLING_INTERVAL);
                    show_screen('screen_login');
                } else {
                    show_screen('screen_register');
                }
            } catch (e) {
                show_screen('screen_setup');
                alert('Erro conexão: ' + e.message);
            }
        }

        async function registrar_token() {
            const p1 = document.getElementById('reg_pass').value;
            const p2 = document.getElementById('reg_pass_conf').value;
            if(!p1 || p1 !== p2) return alert('Senhas inválidas');

            document.getElementById('btn_criar_token').disabled = true;
            document.getElementById('btn_criar_token').innerText = 'ENVIANDO...';

            const hash = await sha256(p1);
            const data = { id:'sys_token', nome:hash, ts:new Date().toISOString(), del:'false' };

            try {
                await send_form(CONFIG.forms.cat, data);
                iniciar_monitoramento();
            } catch(e) {
                alert('Erro: '+e.message);
                document.getElementById('btn_criar_token').disabled = false;
            }
        }

        function iniciar_monitoramento() {
            show_screen('screen_wait');
            let tries = 1;
            POLLING_INTERVAL = setInterval(async () => {
                document.getElementById('try_count').innerText = tries++;
                try {
                    const res = await fetch(CONFIG.csvs.cat + '&t=' + Date.now());
                    const txt = await res.text();
                    if(txt.includes('sys_token')) {
                        clearInterval(POLLING_INTERVAL);
                        document.getElementById('wait_diag').lastElementChild.innerHTML = `<div class="d-icon d-ok"><i class="ph ph-check-circle"></i></div><span>Sincronizado!</span>`;
                        setTimeout(() => verificar_token_remoto(), 1500);
                    }
                } catch(e){}
            }, 10000);
        }

        // === 3. LOGIN & APP LOAD ===
        async function auth() {
            const pass = document.getElementById('login_pass').value;
            const hash = await sha256(pass);
            if (hash === REMOTE_TOKEN_HASH) {
                show_loader(true, 'Carregando dados...');
                load_app_data();
            } else {
                document.getElementById('login_err').innerText = 'Senha incorreta';
            }
        }

        async function load_app_data() {
            try {
                const res = await fetch(CONFIG.csvs.rec + '&t=' + Date.now());
                const txt = await res.text();
                parse_main_csv(txt);
            } catch(e) {}
            
            // Seed cats if empty
            if(DATA.cats.length===0) ['Trabalhos','Projetos','Estudos','Hobbyes','Esportes','Saúde','Família'].forEach(c=>DATA.cats.push({id:'c'+Math.random(),nome:c}));
            
            nav('dashboard');
            show_screen('screen_app');
            show_loader(false);
        }

        // === 4. PARSERS & UTILS ===
        function parse_link(url, mapping) {
            try {
                if (!url.includes('viewform')) throw new Error();
                const base = url.split('/viewform')[0] + '/formResponse';
                const params = new URLSearchParams(url.split('?')[1]);
                const entries = {};
                for (let [key, tag] of Object.entries(mapping)) {
                    params.forEach((val, pKey) => { if (val.trim() === tag) entries[key] = pKey; });
                }
                return { url: base, entries };
            } catch (e) { return null; }
        }

        function parse_csv_simple(txt) {
            const rows = [];
            txt.split('\n').forEach(line => {
                const row = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                if(row) rows.push(row.map(c => c.replace(/^"|"$/g, '')));
            });
            return rows;
        }

        function parse_main_csv(txt) {
            const rows = parse_csv_simple(txt);
            DATA.recs = [];
            rows.forEach(r => {
                const id = r.find(c => c.startsWith('r'));
                if(id) {
                    const i = r.indexOf(id);
                    // Procura campos relativos ao ID
                    if(r[i+1]) DATA.recs.push({
                        id:r[i], titulo:r[i+1], data:r[i+2], hora:r[i+3], valor:r[i+4], 
                        cat:r[i+5], rec:r[i+6], status:r[i+7], det:r[i+8], ts:r[i+9], del:r[i+10]
                    });
                }
            });
            render();
        }

        async function send_form(cfg, data) {
            const fd = new URLSearchParams();
            for(let [key, entryId] of Object.entries(cfg.entries)) { fd.append(entryId, data[key]||''); }
            await fetch(cfg.url, { method: 'POST', mode: 'no-cors', body: fd });
        }
        async function sha256(s) {
            const b = new TextEncoder().encode(s);
            const h = await crypto.subtle.digest('SHA-256', b);
            return Array.from(new Uint8Array(h)).map(x => x.toString(16).padStart(2,'0')).join('');
        }

        // === UI & RENDER (Standard v6) ===
        function nav(view) {
            VIEW = view; toggle_drawer(false);
            const t = { dashboard:'Dashboard', todos:'Todos', fin:'Financeiro', org:'Organizacional', cats:'Categorias' };
            document.getElementById('page_title').innerText = t[view] || 'App';
            document.getElementById('dash_kpi').style.display = (view === 'dashboard') ? 'grid' : 'none';
            render();
        }

        function render() {
            const list = document.getElementById('list_content'); list.innerHTML = '';
            let items = DATA.recs.filter(r => r.del !== 'true'); 
            
            if(VIEW === 'fin') items = items.filter(r => Number(r.valor) > 0);
            if(VIEW === 'org') items = items.filter(r => !r.valor || Number(r.valor)===0);
            
            const search = document.getElementById('f_search').value.toLowerCase();
            const f_st = document.getElementById('f_status').value;
            const f_cat = document.getElementById('f_cat').value;
            if(search) items = items.filter(r => (r.titulo||'').toLowerCase().includes(search));
            if(f_st !== 'todos') items = items.filter(r => r.status === f_st);
            if(f_cat !== 'todos') items = items.filter(r => r.cat === f_cat);

            calc_kpi(items);
            document.getElementById('list_count').innerText = items.length;

            if(items.length===0) { list.innerHTML='<div style="padding:2rem;text-align:center;color:var(--text-sec)">Nada aqui.</div>'; return; }

            items.forEach(r => {
                const is_fin = Number(r.valor) > 0;
                const val = is_fin ? Number(r.valor).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '';
                const date = (r.data||'').split('-').reverse().join('/');
                list.innerHTML += `
                <div class="row">
                    <div class="r-check ${r.status}" onclick="cycle_status('${r.id}')"></div>
                    <div class="r-main" onclick="edit_item('${r.id}')">
                        <div class="r-title">${r.titulo}</div>
                        <div class="r-meta"><span class="r-cat">${r.cat}</span><span>${date}</span></div>
                    </div>
                    <div class="r-val">${val}</div>
                </div>`;
            });
        }
        
        function calc_kpi(items) {
            let bal=0, in_=0, out=0, task=0, pend=0, ok=0;
            items.forEach(r => {
                const v = Number(r.valor||0);
                if(v>0) { if(r.cat==='Trabalhos') { in_+=v; bal+=v; } else { out+=v; bal-=v; } } 
                else { task++; if(r.status==='pendente') pend++; if(r.status==='concluido') ok++; }
            });
            document.getElementById('kpi_bal').innerText = bal.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('kpi_in').innerText = in_.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('kpi_out').innerText = out.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            document.getElementById('kpi_task').innerText = task; document.getElementById('kpi_pend').innerText = pend; document.getElementById('kpi_ok').innerText = ok;
        }

        // CRUD
        function toggle_drawer(f){ const d=document.getElementById('drawer'); const o=document.getElementById('drawer_overlay'); if(f===false||d.classList.contains('open')){d.classList.remove('open');o.classList.remove('open');}else{d.classList.add('open');o.classList.add('open');} }
        function toggle_filters(){ document.getElementById('filters_bar').classList.toggle('open'); }
        function modal_open(){ document.getElementById('e_id').value=''; document.getElementById('e_data').value=new Date().toISOString().split('T')[0]; document.getElementById('modal_overlay').classList.add('open'); populate_cats(); }
        function modal_close(){ document.getElementById('modal_overlay').classList.remove('open'); }
        function populate_cats(){ const s=document.getElementById('e_cat'); s.innerHTML=''; DATA.cats.forEach(c=>s.innerHTML+=`<option value="${c.nome}">${c.nome}</option>`); }
        function edit_item(id){ 
            const r=DATA.recs.find(i=>i.id===id); document.getElementById('e_id').value=r.id; document.getElementById('e_titulo').value=r.titulo; document.getElementById('e_data').value=r.data; document.getElementById('e_valor').value=r.valor; 
            populate_cats(); document.getElementById('e_cat').value=r.cat; document.getElementById('e_status').value=r.status; document.getElementById('modal_overlay').classList.add('open'); 
        }
        function save_item(){
            const id=document.getElementById('e_id').value||'r'+Date.now();
            const item={id, titulo:document.getElementById('e_titulo').value, data:document.getElementById('e_data').value, valor:document.getElementById('e_valor').value, cat:document.getElementById('e_cat').value, status:'pendente', del:'false'};
            const idx=DATA.recs.findIndex(r=>r.id===id); if(idx>-1)DATA.recs[idx]=item; else DATA.recs.push(item);
            QUEUE.push({type:'rec',data:item}); render(); modal_close();
        }
        function del_item(){ const id=document.getElementById('e_id').value; if(id){ const r=DATA.recs.find(i=>i.id===id); r.del='true'; QUEUE.push({type:'rec',data:r}); render(); modal_close(); } }
        async function sincronizar(){ alert('Enviando '+QUEUE.length+' itens...'); for(let q of QUEUE){ await send_form(CONFIG.forms[q.type], q.data); } QUEUE=[]; alert('OK'); }
        function logout(){ location.reload(); }
    </script>
</body>
</html>