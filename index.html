<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NN Planner | Ton Alexandre</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        zinc: {
                            50: '#fafafa',
                            100: '#f4f4f5',
                            200: '#e4e4e7',
                            300: '#d4d4d8',
                            400: '#a1a1aa',
                            500: '#71717a',
                            800: '#27272a',
                            900: '#18181b',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #fafafa; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e4e4e7; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- DATA MODULE ---
        const STORAGE_KEY = 'nn_planner_config';

        // IDs do Form de Registros (Transações)
        const FORM_RECORDS_MAP = {
            id: 'entry.1839248024',
            titulo: 'entry.1045175554',
            data_prevista: 'entry.760139310',
            data_realizada: 'entry.1447613388',
            valor: 'entry.1805224440',
            categoria: 'entry.1854217840',
            status: 'entry.1060678570',
        };

        // IDs do Form de Parâmetros (Config)
        const FORM_PARAMS_MAP = {
            label: 'entry.1097139386',
            value: 'entry.1455409067'
        };

        // CSV Parser Genérico
        const parseCSV = (text) => {
            const lines = text.split('\n').filter(l => l.trim() !== '');
            if (lines.length === 0) return [];
            
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            return lines.slice(1).map(line => {
                // Regex para lidar com vírgulas dentro de aspas
                const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const splitValues = line.split(','); // Fallback
                
                const entry = {};
                headers.forEach((h, i) => {
                    let val = (values[i] || splitValues[i] || '').replace(/^"|"$/g, '').trim();
                    entry[h] = val;
                });
                return entry;
            });
        };

        // --- LOGIC: PROCESS RECORDS (Reduce Algorithm) ---
        const processTransactions = (rawList) => {
            const groups = {};
            
            rawList.forEach(r => {
                // Busca dinâmica de colunas baseada em palavras-chave se o header exato falhar
                const keys = Object.keys(r);
                const idKey = keys.find(k => k.includes('id') || k.includes('1839')); 
                if (!idKey || !r[idKey]) return;
                
                const id = r[idKey];
                if (!groups[id]) groups[id] = [];
                groups[id].push(r);
            });

            const cleanList = [];
            
            Object.values(groups).forEach(group => {
                // Sort by Timestamp (assumed 1st column usually)
                group.sort((a, b) => {
                    const tA = Object.values(a)[0]; 
                    const tB = Object.values(b)[0];
                    return new Date(tA) - new Date(tB);
                });
                
                const latest = group[group.length - 1];
                const keys = Object.keys(latest);
                
                // Mapping seguro
                const mapped = {
                    original_id: latest[keys.find(k => k.includes('id') || k.includes('1839'))],
                    title: latest[keys.find(k => k.includes('titulo') || k.includes('1045'))] || 'Sem título',
                    date_prev: latest[keys.find(k => k.includes('prevista') || k.includes('7601'))],
                    value: parseFloat((latest[keys.find(k => k.includes('valor') || k.includes('1805'))] || '0').replace(',', '.')),
                    category: latest[keys.find(k => k.includes('categoria') || k.includes('1854'))],
                    status: latest[keys.find(k => k.includes('status') || k.includes('1060'))],
                };

                // Type Logic
                mapped.type = mapped.value === 0 ? 'organizational' : 'financial';

                // Filter deleted/void
                if (mapped.status !== 'void' && mapped.status !== 'deleted') {
                    cleanList.push(mapped);
                }
            });

            return cleanList.sort((a, b) => new Date(a.date_prev) - new Date(b.date_prev));
        };

        // --- LOGIC: PROCESS CONFIGS ---
        const processConfigs = (rawList) => {
            const groups = {};
            // Agrupa por Label (Key)
            rawList.forEach(r => {
                const keys = Object.keys(r);
                const labelKey = keys.find(k => k.includes('label') || k.includes('1097'));
                if (!labelKey || !r[labelKey]) return;
                
                const label = r[labelKey];
                if (!groups[label]) groups[label] = [];
                groups[label].push(r);
            });

            const configMap = {};
            Object.keys(groups).forEach(label => {
                const group = groups[label];
                // Última versão vence
                const latest = group[group.length - 1];
                const keys = Object.keys(latest);
                const valKey = keys.find(k => k.includes('valor') || k.includes('1455'));
                
                configMap[label] = latest[valKey];
            });
            return configMap;
        };

        const postToForm = async (url, dataMap) => {
            const formData = new URLSearchParams();
            for (const [key, value] of Object.entries(dataMap)) {
                formData.append(key, value);
            }
            try {
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                return true;
            } catch (e) {
                console.error("Erro envio form", e);
                return false;
            }
        };

        // --- UI COMPONENTS ---

        const Button = ({ children, onClick, variant = 'primary', className = "", disabled=false }) => {
            const base = "font-mono text-xs uppercase tracking-widest transition-colors py-3 rounded-sm flex items-center justify-center gap-2";
            const styles = {
                primary: "bg-zinc-900 text-white hover:bg-zinc-800",
                secondary: "bg-white border border-zinc-200 text-zinc-900 hover:bg-zinc-50",
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${base} ${styles[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}>
                    {children}
                </button>
            );
        };

        const Input = ({ label, value, onChange, type = "text", placeholder }) => (
            <div className="flex flex-col gap-1 mb-4">
                <label className="text-[10px] uppercase tracking-wider font-mono text-zinc-400">{label}</label>
                <input 
                    type={type} 
                    value={value} 
                    onChange={e => onChange(e.target.value)}
                    placeholder={placeholder}
                    className="w-full bg-transparent border-b border-zinc-300 py-2 font-mono text-sm outline-none text-zinc-900 focus:border-black transition-colors placeholder-zinc-300"
                />
            </div>
        );

        // --- VIEWS ---

        const SetupView = ({ onComplete }) => {
            const [step, setStep] = useState(1); // 1: Master Link, 2: Full Manual
            const [masterLink, setMasterLink] = useState('');
            const [fullConfig, setFullConfig] = useState({
                form_params: '',
                form_registros: '',
                csv_registros: ''
            });
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');

            const handleMasterSubmit = async () => {
                setLoading(true);
                setErrorMsg('');
                
                if (!masterLink.includes('docs.google.com') || !masterLink.includes('output=csv')) {
                    setErrorMsg("Link CSV inválido. Certifique-se que termina com output=csv");
                    setLoading(false);
                    return;
                }

                try {
                    // Tenta baixar o CSV Mestre
                    const res = await fetch(masterLink);
                    const text = await res.text();
                    const raw = parseCSV(text);
                    const configs = processConfigs(raw); // "Reduce" nos params

                    if (configs['app_config_backup']) {
                        // BINGO! Configuração encontrada
                        try {
                            const restored = JSON.parse(configs['app_config_backup']);
                            // Garante que o csv_parametros salvo é o que foi usado agora
                            restored.csv_parametros = masterLink; 
                            
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(restored));
                            onComplete(restored);
                            return;
                        } catch (e) {
                            console.error("Erro parse JSON config", e);
                        }
                    } 
                    
                    // Se chegou aqui, não achou config válida. Vai pro passo 2
                    // Mas preserva o link do master csv como 'csv_parametros' (que não usamos pra escrita, mas pra leitura futura)
                    // Na verdade precisamos do FORM Parametros para escrever.
                    setErrorMsg("Configuração não encontrada neste CSV. Preencha os dados para inicializar.");
                    setStep(2);
                    
                } catch (e) {
                    setErrorMsg("Erro ao ler CSV. Verifique permissões ou link.");
                } finally {
                    setLoading(false);
                }
            };

            const handleFullSave = async () => {
                setLoading(true);
                // Salva Local
                const configToSave = { ...fullConfig, csv_parametros: masterLink }; // Opcional guardar o master link de leitura
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(configToSave));

                // Escreve no CSV Mestre (via Form Params) para futuro
                const configPayload = JSON.stringify(configToSave);
                await postToForm(fullConfig.form_params, {
                    [FORM_PARAMS_MAP.label]: 'app_config_backup',
                    [FORM_PARAMS_MAP.value]: configPayload
                });

                setLoading(false);
                onComplete(configToSave);
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 max-w-md mx-auto">
                    <div className="mb-8 text-center">
                        <h1 className="text-xl font-bold tracking-tight mb-2">NN Planner</h1>
                        <p className="text-zinc-500 text-sm">Acesso ao Sistema</p>
                    </div>
                    
                    <div className="w-full bg-white p-6 border border-zinc-200 rounded-sm shadow-sm animate-in fade-in slide-in-from-bottom-4">
                        {step === 1 && (
                            <>
                                <Input 
                                    label="Link CSV Parâmetros (Master)" 
                                    value={masterLink} 
                                    onChange={setMasterLink} 
                                    placeholder="https://docs.google.com/...output=csv" 
                                />
                                {errorMsg && <p className="text-xs text-red-500 mb-4 font-mono">{errorMsg}</p>}
                                <Button onClick={handleMasterSubmit} disabled={loading} className="w-full">
                                    {loading ? "Buscando Configuração..." : "Carregar"}
                                </Button>
                            </>
                        )}

                        {step === 2 && (
                            <div className="animate-in fade-in">
                                <p className="text-xs text-zinc-500 mb-4">Primeiro acesso detectado. Informe os links de escrita.</p>
                                <Input label="Link Form Parâmetros (Escrita)" value={fullConfig.form_params} onChange={v => setFullConfig({...fullConfig, form_params: v})} />
                                <Input label="Link Form Registros (Escrita)" value={fullConfig.form_registros} onChange={v => setFullConfig({...fullConfig, form_registros: v})} />
                                <Input label="Link CSV Registros (Leitura)" value={fullConfig.csv_registros} onChange={v => setFullConfig({...fullConfig, csv_registros: v})} />
                                
                                <Button onClick={handleFullSave} disabled={loading} className="w-full mt-2">
                                    {loading ? "Inicializando..." : "Salvar e Conectar"}
                                </Button>
                                <button onClick={() => setStep(1)} className="w-full text-center mt-4 text-[10px] uppercase text-zinc-400 hover:text-zinc-900">Voltar</button>
                            </div>
                        )}
                    </div>
                    <p className="mt-8 text-[10px] text-zinc-400 font-mono uppercase tracking-widest">Ton Alexandre System</p>
                </div>
            );
        };

        const Dashboard = ({ records }) => {
            const todayStr = new Date().toISOString().split('T')[0];
            
            const stats = useMemo(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                // Filtra mês atual
                const monthly = records.filter(r => {
                    if (r.status === 'void') return false;
                    const d = new Date(r.date_prev);
                    // Ajuste de fuso simples: considera string YYYY-MM-DD
                    const [y, m] = r.date_prev.split('-');
                    return parseInt(m) === currentMonth + 1 && parseInt(y) === currentYear;
                });
                
                const income = monthly.filter(r => r.value > 0).reduce((acc, r) => acc + r.value, 0);
                const expenses = monthly.filter(r => r.value < 0).reduce((acc, r) => acc + r.value, 0);
                
                return { income, expenses, balance: income + expenses };
            }, [records]);

            const todayList = records.filter(r => r.date_prev === todayStr && r.status !== 'completed' && r.status !== 'paid' && r.status !== 'void');

            return (
                <div className="space-y-8 animate-in fade-in duration-500">
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white p-4 border border-zinc-200 rounded-sm">
                            <span className="text-[10px] uppercase tracking-wider text-zinc-400 font-mono">Saldo Mês</span>
                            <div className={`font-mono text-xl mt-1 ${stats.balance < 0 ? 'text-red-500' : 'text-zinc-900'}`}>
                                R$ {stats.balance.toFixed(2)}
                            </div>
                        </div>
                        <div className="bg-white p-4 border border-zinc-200 rounded-sm">
                            <span className="text-[10px] uppercase tracking-wider text-zinc-400 font-mono">Saídas Previstas</span>
                            <div className="font-mono text-xl mt-1 text-zinc-500">
                                R$ {Math.abs(stats.expenses).toFixed(2)}
                            </div>
                        </div>
                    </div>

                    <div>
                        <div className="flex items-center justify-between mb-4 border-b border-zinc-100 pb-2">
                            <h3 className="font-mono text-xs uppercase tracking-widest text-zinc-400">Hoje</h3>
                            <span className="text-[10px] font-mono bg-zinc-100 px-2 py-0.5 rounded-full text-zinc-500">{todayList.length}</span>
                        </div>
                        
                        {todayList.length === 0 ? (
                            <p className="text-sm text-zinc-400 italic">Nada pendente para hoje.</p>
                        ) : (
                            <div className="space-y-3">
                                {todayList.map((item, i) => (
                                    <div key={i} className="flex items-center justify-between p-3 bg-white border border-zinc-100 rounded-sm hover:border-zinc-300 transition-colors">
                                        <div className="flex flex-col">
                                            <span className="text-sm font-medium text-zinc-800">{item.title}</span>
                                            <span className="text-[10px] text-zinc-400 uppercase tracking-wide">{item.category}</span>
                                        </div>
                                        {item.value !== 0 && (
                                            <span className={`font-mono text-sm ${item.value < 0 ? 'text-red-400' : 'text-zinc-600'}`}>
                                                {item.value.toFixed(2)}
                                            </span>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ListView = ({ records, typeFilter }) => {
            const filtered = records.filter(r => {
                if (typeFilter === 'all') return true;
                return r.type === typeFilter;
            });

            return (
                <div className="space-y-4 animate-in slide-in-from-bottom-4 duration-500">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-lg font-light text-zinc-900">
                            {typeFilter === 'all' ? 'Visão Geral' : typeFilter === 'financial' ? 'Financeiro' : 'Tarefas'}
                        </h2>
                        <button className="text-zinc-400 hover:text-zinc-900"><Icon name="filter" /></button>
                    </div>

                    {filtered.length === 0 && <p className="text-sm text-zinc-400 text-center py-8">Nenhum registro encontrado.</p>}

                    {filtered.map((item, i) => (
                        <div key={i} className="bg-white p-4 border border-zinc-200 rounded-sm flex justify-between items-center">
                            <div>
                                <div className="text-sm text-zinc-900 font-medium">{item.title}</div>
                                <div className="flex gap-2 mt-1">
                                    <span className="text-[10px] font-mono text-zinc-400 bg-zinc-50 px-1 rounded">{item.date_prev.split('-').reverse().slice(0,2).join('/')}</span>
                                    <span className="text-[10px] font-mono text-zinc-400 uppercase">{item.category}</span>
                                </div>
                            </div>
                            <div className="text-right">
                                {item.value !== 0 && (
                                    <div className={`font-mono text-sm ${item.value < 0 ? 'text-zinc-900' : 'text-zinc-500'}`}>
                                        {item.value.toFixed(2)}
                                    </div>
                                )}
                                <div className={`w-2 h-2 rounded-full ml-auto mt-2 ${item.status === 'paid' || item.status === 'completed' ? 'bg-zinc-900' : 'bg-zinc-200'}`}></div>
                            </div>
                        </div>
                    ))}
                    <div className="h-20"></div>
                </div>
            );
        };

        const NewRecordModal = ({ isOpen, onClose, config }) => {
            const [formData, setFormData] = useState({
                title: '',
                value: '',
                date: new Date().toISOString().split('T')[0],
                category: 'Geral',
                type: 'financial'
            });
            const [saving, setSaving] = useState(false);

            if (!isOpen) return null;

            const handleSubmit = async () => {
                if (!config || !config.form_registros) {
                    alert("Erro de configuração: Link de Form de Registros não encontrado.");
                    return;
                }
                setSaving(true);
                const id = Date.now().toString();
                const finalValue = formData.type === 'organizational' ? 0 : parseFloat(formData.value || 0);
                
                const payload = {
                    [FORM_RECORDS_MAP.id]: id,
                    [FORM_RECORDS_MAP.titulo]: formData.title,
                    [FORM_RECORDS_MAP.data_prevista]: formData.date,
                    [FORM_RECORDS_MAP.valor]: finalValue,
                    [FORM_RECORDS_MAP.categoria]: formData.category,
                    [FORM_RECORDS_MAP.status]: 'pending',
                    [FORM_RECORDS_MAP.data_realizada]: '', 
                };

                const success = await postToForm(config.form_registros, payload);
                setSaving(false);
                if (success) {
                    alert("Registro salvo. A atualização aparecerá em breve.");
                    onClose();
                } else {
                    alert("Erro ao enviar para o Google Forms.");
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-sm p-4 animate-in fade-in">
                    <div className="bg-white w-full max-w-md p-6 rounded-sm shadow-xl border border-zinc-200 animate-in slide-in-from-bottom-10">
                        <div className="flex justify-between items-center mb-6 border-b border-zinc-100 pb-2">
                            <h3 className="font-mono text-xs uppercase tracking-widest text-zinc-900">Novo Registro</h3>
                            <button onClick={onClose}><Icon name="x" className="text-zinc-400" /></button>
                        </div>

                        <div className="flex gap-2 mb-6">
                            <button 
                                onClick={() => setFormData({...formData, type: 'financial'})}
                                className={`flex-1 py-2 text-xs font-mono uppercase tracking-widest border ${formData.type === 'financial' ? 'bg-zinc-900 text-white border-zinc-900' : 'text-zinc-400 border-zinc-200'}`}
                            >
                                Financeiro
                            </button>
                            <button 
                                onClick={() => setFormData({...formData, type: 'organizational'})}
                                className={`flex-1 py-2 text-xs font-mono uppercase tracking-widest border ${formData.type === 'organizational' ? 'bg-zinc-900 text-white border-zinc-900' : 'text-zinc-400 border-zinc-200'}`}
                            >
                                Tarefa
                            </button>
                        </div>

                        <Input label="Título" value={formData.title} onChange={v => setFormData({...formData, title: v})} placeholder="Título..." />
                        
                        {formData.type === 'financial' && (
                             <Input label="Valor (Use - para despesa)" type="number" value={formData.value} onChange={v => setFormData({...formData, value: v})} placeholder="-0.00" />
                        )}

                        <Input label="Data Prevista" type="date" value={formData.date} onChange={v => setFormData({...formData, date: v})} />
                        
                        <div className="mb-6">
                             <label className="text-[10px] uppercase tracking-wider font-mono text-zinc-400 mb-1 block">Categoria</label>
                             <select 
                                value={formData.category} 
                                onChange={e => setFormData({...formData, category: e.target.value})}
                                className="w-full bg-transparent border-b border-zinc-300 py-2 font-mono text-sm outline-none text-zinc-900"
                             >
                                <option>Geral</option>
                                <option>Alimentação</option>
                                <option>Contas Fixas</option>
                                <option>Lazer</option>
                                <option>Filho</option>
                                <option>Transporte</option>
                                <option>Receita</option>
                             </select>
                        </div>

                        <Button onClick={handleSubmit} disabled={saving} className="w-full">
                            {saving ? "Salvando..." : "Confirmar"}
                        </Button>
                    </div>
                </div>
            );
        };

        const Layout = ({ children, activeTab, onTabChange, onAdd }) => {
            return (
                <div className="min-h-screen bg-zinc-50 pb-24">
                    <header className="fixed top-0 left-0 right-0 z-40 bg-zinc-50/90 backdrop-blur-sm border-b border-zinc-200 h-14 flex items-center justify-between px-6">
                        <span className="font-sans font-semibold text-sm tracking-tight text-zinc-900">NN Planner</span>
                        <span className="font-mono text-[10px] text-zinc-300 uppercase tracking-widest hidden sm:block">Ton Alexandre</span>
                    </header>
                    <main className="pt-20 px-6 max-w-md mx-auto">
                        {children}
                    </main>
                    <button onClick={onAdd} className="fixed bottom-20 right-6 w-12 h-12 bg-zinc-900 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-black transition-transform active:scale-95 z-40">
                        <Icon name="plus" />
                    </button>
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-zinc-200 h-16 flex items-center justify-around px-6 z-40 pb-safe">
                        {['dash', 'fin', 'org', 'settings'].map(tab => (
                            <button key={tab} onClick={() => onTabChange(tab)} className={`p-2 rounded-full ${activeTab === tab ? 'bg-zinc-100 text-zinc-900' : 'text-zinc-400'}`}>
                                <Icon name={tab === 'dash' ? 'layout-dashboard' : tab === 'fin' ? 'wallet' : tab === 'org' ? 'check-square' : 'settings'} />
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };

        const App = () => {
            const [config, setConfig] = useState(null);
            const [records, setRecords] = useState([]);
            const [view, setView] = useState('dash');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [loadingData, setLoadingData] = useState(false);

            useEffect(() => {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    setConfig(parsed);
                    fetchData(parsed.csv_registros);
                }
            }, []);

            const fetchData = async (url) => {
                if (!url) return;
                setLoadingData(true);
                try {
                    const res = await fetch(url);
                    const text = await res.text();
                    const raw = parseCSV(text);
                    const processed = processTransactions(raw);
                    setRecords(processed);
                } catch (err) {
                    console.error("Erro fetch records", err);
                } finally {
                    setLoadingData(false);
                }
            };

            const handleSetupComplete = (newConfig) => {
                setConfig(newConfig);
                fetchData(newConfig.csv_registros);
            };

            const handleRefresh = () => { if(config) fetchData(config.csv_registros); }
            const handleReset = () => { localStorage.removeItem(STORAGE_KEY); setConfig(null); }

            if (!config) return <SetupView onComplete={handleSetupComplete} />;

            return (
                <>
                <Layout activeTab={view} onTabChange={setView} onAdd={() => setIsModalOpen(true)}>
                    {view === 'dash' && <Dashboard records={records} />}
                    {view === 'fin' && <ListView records={records} typeFilter="financial" />}
                    {view === 'org' && <ListView records={records} typeFilter="organizational" />}
                    {view === 'settings' && (
                        <div className="space-y-4 animate-in fade-in">
                            <h2 className="text-lg font-light mb-4">Configurações</h2>
                            <div className="p-4 bg-white border border-zinc-200 rounded-sm">
                                <p className="text-xs font-mono text-zinc-400 mb-2">INFRAESTRUTURA</p>
                                <p className="text-[10px] text-zinc-500 break-all mb-4">{config.csv_registros}</p>
                                <Button variant="secondary" onClick={handleReset} className="w-full">Desconectar</Button>
                            </div>
                            <Button variant="secondary" onClick={handleRefresh} className="w-full">
                                {loadingData ? "Atualizando..." : "Forçar Atualização"}
                            </Button>
                        </div>
                    )}
                </Layout>
                <NewRecordModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} config={config} />
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 100);
    </script>
</body>
</html>