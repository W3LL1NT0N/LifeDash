<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LIDA Journal v0</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        :root {
            --bg-body: #f8fafc; --bg-surface: #ffffff; --border: #e2e8f0;
            --text-main: #0f172a; --text-sec: #64748b;
            --fin: #0ea5e9; --org: #8b5cf6;
            --ok: #10b981; --warn: #f59e0b; --err: #ef4444; --dark: #1e293b;
            --radius: 8px; --header-h: 60px; --sidebar-w: 280px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Noto Sans', sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 14px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; background: var(--bg-body); }
        .screen.active { display: flex; animation: fade_in 0.2s ease-out; }
        @keyframes fade_in { from { opacity: 0; } to { opacity: 1; } }

        /* AUTH & SETUP */
        .center-box { max-width: 600px; margin: 2rem auto; padding: 1.5rem; }
        .auth-card { background: var(--bg-surface); padding: 2rem; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .setup-block { background: #f1f5f9; padding: 1.5rem; border-radius: var(--radius); margin-bottom: 2rem; border: 1px solid var(--border); }
        .block-header { font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; color: var(--dark); }
        .inp-label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-sec); margin: 0.5rem 0 0.3rem; text-transform: uppercase; }
        .input-std { width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.95rem; background: #fff; color: var(--text-main); }
        .btn { width: 100%; padding: 0.9rem; border-radius: var(--radius); font-weight: 700; cursor: pointer; border: none; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: 0.2s; }
        .btn-primary { background: var(--dark); color: #fff; }
        .btn-ghost { background: transparent; color: var(--text-sec); border: 1px solid var(--border); }
        .tag-box { font-family: monospace; font-size: 0.7rem; background: #e2e8f0; padding: 0.5rem; border-radius: 4px; color: var(--text-main); word-break: break-all; margin-bottom: 0.5rem; }

        /* APP UI */
        header { height: var(--header-h); background: var(--bg-surface); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; flex-shrink: 0; z-index: 20; }
        .h-title { font-weight: 700; font-size: 1.1rem; color: var(--dark); }
        .btn-icon { background: transparent; border: none; font-size: 1.5rem; padding: 0.5rem; cursor: pointer; color: var(--text-sec); border-radius: 50%; }
        .filters-bar { background: var(--bg-surface); border-bottom: 1px solid var(--border); padding: 0.5rem 1rem; display: none; gap: 0.5rem; flex-wrap: wrap; }
        .filters-bar.open { display: flex; }
        .f-input { padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 20px; font-size: 0.85rem; background: var(--bg-body); }
        .f-search { flex: 1; min-width: 150px; }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; padding: 1rem; }
        .kpi-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; display: flex; flex-direction: column; }
        .kpi-fin { border-top: 4px solid var(--fin); } .kpi-org { border-top: 4px solid var(--org); }
        .kpi-val { font-size: 1.4rem; font-weight: 700; font-family: monospace; margin: 0.5rem 0; }
        .kpi-lbl { font-size: 0.75rem; font-weight: 700; color: var(--text-sec); text-transform: uppercase; }

        .list-container { flex: 1; overflow-y: auto; padding: 0 1rem 5rem; }
        .list-header { font-size: 0.8rem; font-weight: 700; color: var(--text-sec); margin: 1rem 0 0.5rem; display: flex; justify-content: space-between; }
        .row { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 0.75rem; margin-bottom: 0.5rem; display: grid; grid-template-columns: 24px 1fr auto; align-items: center; gap: 1rem; position: relative; overflow: hidden; }
        .row.divergent { border-left: 4px solid var(--warn); }
        .r-check { width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--border); cursor: pointer; display: grid; place-items: center; }
        .r-check.checked { background: var(--ok); border-color: var(--ok); }
        .r-check.checked::after { content: '✓'; color: white; font-weight: bold; font-size: 14px; }
        .r-title { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .r-meta { font-size: 0.75rem; color: var(--text-sec); display: flex; gap: 0.5rem; align-items: center; }
        .r-tag { background: var(--bg-body); padding: 2px 6px; border-radius: 4px; font-weight: 700; font-size: 0.7rem; text-transform: uppercase; }
        .r-val { font-family: monospace; font-weight: 700; font-size: 0.95rem; }

        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; }
        .drawer-overlay.open { display: block; }
        aside { position: fixed; top: 0; left: 0; bottom: 0; width: var(--sidebar-w); background: var(--bg-surface); border-right: 1px solid var(--border); z-index: 50; transform: translateX(-100%); transition: 0.3s; padding: 1.5rem; display: flex; flex-direction: column; }
        aside.open { transform: translateX(0); }
        .nav-btn { width: 100%; padding: 0.8rem; text-align: left; background: none; border: none; color: var(--text-sec); font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.8rem; border-radius: var(--radius); }
        .nav-btn.active { background: var(--bg-body); color: var(--dark); font-weight: 700; }
        .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: var(--dark); color: #fff; border-radius: 50%; display: grid; place-items: center; font-size: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); cursor: pointer; z-index: 30; }

        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 200; display: none; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
        .log-row { font-family: monospace; font-size: 0.8rem; padding: 0.5rem; border-bottom: 1px solid var(--border); display: flex; gap: 1rem; }
        .log-ok { color: var(--ok); } .log-fail { color: var(--err); }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--bg-surface); width: 95%; max-width: 500px; padding: 0; border-radius: 12px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--ok); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

    <div id="loader"><i class="ph ph-spinner ph-spin" style="font-size: 2.5rem; color: var(--dark);"></i><div style="font-weight: 600;">Carregando...</div></div>

    <!-- 1. SETUP (NOVA CONEXÃO) -->
    <div id="screen_setup" class="screen">
        <div class="center-box">
            <h1 style="text-align: center; margin-bottom: 2rem;">Setup LIDA v0</h1>
            
            <div class="auth-card">
                <h3 style="margin-bottom: 1rem;">Acesso & Personalização</h3>
                <div class="form-group"><span class="inp-label">Usuário</span><input type="text" id="set_user" class="input-std"></div>
                <div class="form-group" style="margin-bottom: 2rem;"><span class="inp-label">Senha</span><input type="password" id="set_pass" class="input-std"></div>

                <!-- LISTAS (CÉREBRO DO SISTEMA) -->
                <div class="setup-block">
                    <div class="block-header"><i class="ph ph-list-checks"></i> 1. Banco de Listas & Config (Obrigatório)</div>
                    <div class="tag-box">TAGS: TAG_ID, TAG_NOME, TAG_TS, TAG_DEL</div>
                    <span class="inp-label">Link Form (Preenchido)</span><input type="text" id="l_form_cat" class="input-std">
                    <span class="inp-label">Link Planilha (CSV)</span><input type="text" id="l_csv_cat" class="input-std">
                </div>

                <!-- REGISTROS -->
                <div class="setup-block">
                    <div class="block-header"><i class="ph ph-database"></i> 2. Banco de Registros</div>
                    <div class="tag-box">TAGS: TAG_ID, TAG_TITULO, TAG_DATA, TAG_HORA, TAG_VALOR, TAG_CAT, TAG_REC, TAG_STATUS, TAG_DET, TAG_TS, TAG_DEL</div>
                    <span class="inp-label">Link Form</span><input type="text" id="l_form_rec" class="input-std">
                    <span class="inp-label">Link CSV</span><input type="text" id="l_csv_rec" class="input-std">
                </div>

                <!-- LOGS -->
                <div class="setup-block">
                    <div class="block-header"><i class="ph ph-scroll"></i> 3. Banco de Logs</div>
                    <div class="tag-box">TAGS: TAG_STATUS, TAG_DATA, TAG_AGENT, TAG_SCREEN, TAG_IP</div>
                    <span class="inp-label">Link Form</span><input type="text" id="l_form_log" class="input-std">
                    <span class="inp-label">Link CSV</span><input type="text" id="l_csv_log" class="input-std">
                </div>

                <button class="btn btn-primary" onclick="sys.do_setup()">SALVAR CONFIG NA NUVEM</button>
                <button class="btn btn-ghost" onclick="sys.goto('login')" style="margin-top: 1rem;">Já fiz isso antes</button>
            </div>
        </div>
    </div>

    <!-- 2. LOGIN (JÁ TENHO CONFIG NA NUVEM) -->
    <div id="screen_login" class="screen">
        <div class="center-box" style="margin-top: 10vh;">
            <div class="auth-card" style="text-align: center;">
                <h1 style="margin-bottom: 2rem;"><i class="ph ph-lock-key"></i> LIDA Journal</h1>
                <p style="color:var(--text-sec); margin-bottom:1rem; font-size:0.85rem;">Insira o link da planilha de Listas para carregar suas configurações.</p>
                
                <div class="form-group" style="text-align: left;">
                    <span class="inp-label">Link CSV Listas</span>
                    <input type="text" id="log_csv_link" class="input-std" placeholder="https://docs.google.com/...output=csv">
                </div>
                
                <div class="form-group" style="text-align: left;">
                    <span class="inp-label">Usuário</span>
                    <input type="text" id="log_user" class="input-std">
                </div>
                <div class="form-group" style="text-align: left; margin-bottom: 2rem;">
                    <span class="inp-label">Senha</span>
                    <input type="password" id="log_pass" class="input-std">
                </div>

                <button class="btn btn-primary" onclick="sys.do_login()">BAIXAR PERFIL E ENTRAR</button>
                <button class="btn btn-ghost" onclick="sys.hard_reset()" style="margin-top: 2rem; color: var(--err); border-color: var(--border);">Novo Setup Local</button>
            </div>
        </div>
    </div>

    <!-- 3. APP DASHBOARD -->
    <div id="screen_app" class="screen">
        <header>
            <button class="btn-icon" onclick="ui.toggleDrawer()"><i class="ph ph-list"></i></button>
            <div class="h-title" id="page_title">LIDA v0</div>
            <div style="display: flex; gap: 0.5rem;">
                <button id="btn_filter" class="btn-icon" onclick="ui.toggleFilters()"><i class="ph ph-funnel"></i></button>
                <button class="btn-icon" onclick="db.sync()" title="Sincronizar"><i class="ph ph-cloud-arrow-up"></i></button>
            </div>
        </header>

        <div id="filters_bar" class="filters-bar">
            <input type="text" id="f_search" class="input-std f-search" style="flex:1; min-width:150px;" placeholder="Buscar..." onkeyup="app.render()">
            <select id="f_period" class="input-std" style="width:auto;" onchange="app.render()">
                <option value="hoje">Hoje</option><option value="ontem">Ontem</option><option value="amanha">Amanhã</option>
                <option value="semana_atual">Esta Semana</option><option value="semana_passada">Semana Passada</option><option value="semana_vem">Semana Que Vem</option>
                <option value="mes_atual" selected>Este Mês</option><option value="mes_passado">Mês Passado</option><option value="mes_vem">Mês Que Vem</option>
                <option value="ano_atual">Este Ano</option><option value="ano_passado">Ano Passado</option><option value="tudo">Tudo</option>
            </select>
            <select id="f_cat" class="input-std" style="width:auto;" onchange="app.render()"><option value="todos">Categoria</option></select>
        </div>

        <div id="drawer_overlay" class="drawer-overlay" onclick="ui.toggleDrawer()"></div>
        <aside id="drawer">
            <div style="font-weight:700; font-size:1.2rem; margin-bottom:2rem; display:flex; gap:0.5rem; align-items:center;">
                <i class="ph ph-squares-four"></i> LIDA Journal
            </div>
            <button class="nav-btn active" onclick="app.nav('dashboard')"><i class="ph ph-chart-pie-slice"></i> Dashboard</button>
            <div style="margin-top:2rem; font-size:0.75rem; font-weight:700; color:#94a3b8; margin-bottom:0.5rem;">REGISTROS</div>
            <button class="nav-btn" onclick="app.nav('todos')"><i class="ph ph-list-dashes"></i> Todos</button>
            <button class="nav-btn" onclick="app.nav('fin')"><i class="ph ph-currency-dollar"></i> Financeiro</button>
            <button class="nav-btn" onclick="app.nav('org')"><i class="ph ph-check-square"></i> Organizacional</button>
            <div style="margin-top:2rem; font-size:0.75rem; font-weight:700; color:#94a3b8; margin-bottom:0.5rem;">SISTEMA</div>
            <button class="nav-btn" onclick="app.nav('logs')"><i class="ph ph-scroll"></i> Logs</button>
            <button class="nav-btn" onclick="app.nav('config')"><i class="ph ph-gear"></i> Configurações</button>
            <button class="nav-btn" onclick="sys.logout()"><i class="ph ph-sign-out"></i> Sair</button>
        </aside>

        <main id="main_content">
            <!-- HOME VIEW -->
            <div id="view_home" class="full-h" style="display: flex; flex-direction: column;">
                <div id="dash_kpi" class="kpi-grid">
                    <div class="kpi-card kpi-fin">
                        <span class="kpi-lbl">Saldo</span><span class="kpi-val" id="k_bal">R$ 0,00</span>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                            <span style="color:var(--ok)">Ent: <span id="k_in">0</span></span>
                            <span style="color:var(--err)">Sai: <span id="k_out">0</span></span>
                        </div>
                    </div>
                    <div class="kpi-card kpi-org">
                        <span class="kpi-lbl">Tarefas</span><span class="kpi-val" id="k_task">0</span>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                            <span style="color:var(--warn)">Pend: <span id="k_pend">0</span></span>
                            <span style="color:var(--ok)">Ok: <span id="k_ok">0</span></span>
                        </div>
                    </div>
                </div>
                <div class="list-container">
                    <div class="list-header"><span id="lbl_list">Registros</span><span id="lbl_count">0</span></div>
                    <div id="list_render"></div>
                </div>
                <div class="fab" onclick="app.openModal()"><i class="ph ph-plus"></i></div>
            </div>

            <!-- CONFIG VIEW -->
            <div id="view_config" class="full-h hidden" style="padding: 1rem;">
                <h3 style="margin-bottom: 1rem;">Preferências</h3>
                <div class="kpi-card" style="margin-bottom: 1.5rem;">
                    <span class="inp-label">Início da Semana</span>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                        <label><input type="radio" name="ws" id="ws_dom" onclick="sys.save_pref(0)"> Domingo</label>
                        <label><input type="radio" name="ws" id="ws_seg" onclick="sys.save_pref(1)"> Segunda</label>
                    </div>
                </div>
                <h3 style="margin-bottom: 1rem;">Categorias</h3>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="text" id="new_cat_name" placeholder="Nova..." class="input-std" style="flex:1;">
                    <button class="btn btn-primary" onclick="db.addCat()" style="width: auto;">Add</button>
                </div>
                <div id="conf_cat_list"></div>
            </div>

            <!-- LOGS VIEW -->
            <div id="view_logs" class="full-h hidden" style="padding: 1rem;">
                <div id="log_list"></div>
            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal_overlay" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Registro</span>
                <button class="btn-icon" onclick="ui.closeModal()"><i class="ph ph-x"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="e_id">
                <div class="form-group"><label class="inp-label">Título</label><input type="text" id="e_titulo" class="input-std"></div>
                <div class="form-grid">
                    <div class="form-group"><label class="inp-label">Data</label><input type="date" id="e_data" class="input-std"></div>
                    <div class="form-group"><label class="inp-label">Hora</label><input type="time" id="e_hora" class="input-std"></div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label class="inp-label">Valor (R$)</label><input type="number" id="e_valor" step="0.01" class="input-std" placeholder="0.00"></div>
                    <div class="form-group"><label class="inp-label">Categoria</label><select id="e_cat" class="input-std"></select></div>
                </div>
                <div class="form-grid" style="align-items:center;">
                    <div class="form-group"><label class="inp-label">Recorrência</label><select id="e_rec" class="input-std"><option value="unica">Única</option><option value="mensal">Mensal</option></select></div>
                    <div class="form-group">
                        <label class="inp-label">Concluído</label>
                        <label class="switch"><input type="checkbox" id="e_status"><span class="slider"></span></label>
                    </div>
                </div>
                <div class="form-group"><label class="inp-label">Detalhes</label><textarea id="e_det" class="input-std" rows="3"></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="db.saveItem()" style="width: auto;">SALVAR</button>
                <button class="btn btn-danger" onclick="db.deleteItem()" style="width: auto;">EXCLUIR</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CORE SYSTEM ---
        const sys = {
            config: {},
            
            init: () => {
                const c = localStorage.getItem('lida_config');
                const s = sessionStorage.getItem('lida_session');
                
                if (c && s === 'ok') {
                    sys.config = JSON.parse(c);
                    sys.goto('app');
                    app.init();
                } else {
                    // Check if local config exists to pre-fill login
                    if(c) {
                        sys.config = JSON.parse(c);
                        if(sys.config.endpoints.cat && sys.config.endpoints.cat.csv) {
                            document.getElementById('log_csv_link').value = sys.config.endpoints.cat.csv;
                        }
                        sys.goto('login');
                    } else {
                        sys.goto('setup');
                    }
                }
            },

            goto: (screen) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('screen_' + screen).classList.add('active');
            },

            do_setup: async () => {
                const user = document.getElementById('set_user').value;
                const pass = document.getElementById('set_pass').value;
                const urls = {
                    rec: { f: document.getElementById('l_form_rec').value, c: document.getElementById('l_csv_rec').value },
                    cat: { f: document.getElementById('l_form_cat').value, c: document.getElementById('l_csv_cat').value },
                    log: { f: document.getElementById('l_form_log').value, c: document.getElementById('l_csv_log').value }
                };

                if(!user || !pass || !urls.rec.f || !urls.cat.c) return alert('Preencha os campos obrigatórios.');

                const maps = {
                    rec: { id:'TAG_ID', titulo:'TAG_TITULO', data:'TAG_DATA', hora:'TAG_HORA', valor:'TAG_VALOR', cat:'TAG_CAT', rec:'TAG_REC', status:'TAG_STATUS', det:'TAG_DET', ts:'TAG_TS', del:'TAG_DEL' },
                    cat: { id:'TAG_ID', nome:'TAG_NOME', ts:'TAG_TS', del:'TAG_DEL' },
                    log: { status:'TAG_STATUS', data:'TAG_DATA', agent:'TAG_AGENT', screen:'TAG_SCREEN', ip:'TAG_IP' }
                };

                // 1. Build Config Object
                const cfg = { user, pass_hash: await utils.sha256(pass), endpoints: {}, prefs: { week_start: 0 } };
                
                for (let k of ['rec','cat','log']) {
                    const p = utils.parse_form_link(urls[k].f, maps[k]);
                    if(!p) return alert(`Erro no link do Form ${k.toUpperCase()}`);
                    cfg.endpoints[k] = { url: p.base, entries: p.entries, csv: urls[k].c };
                }

                // 2. Save Config to LISTS Form (Cloud Storage of Profile)
                // We save it as a special row: ID='sys_config', NOME=JSON.stringify(cfg)
                const configRow = {
                    id: 'sys_config',
                    nome: JSON.stringify(cfg),
                    ts: new Date().toISOString(),
                    del: 'false'
                };

                ui.loader(true, 'Salvando perfil na nuvem...');
                try {
                    await utils.send_form(cfg.endpoints.cat, configRow);
                    // Also save locally
                    localStorage.setItem('lida_config', JSON.stringify(cfg));
                    sessionStorage.setItem('lida_session', 'ok');
                    
                    // Add default cats if needed
                    ['Trabalhos','Projetos','Contas'].forEach(c => {
                       utils.send_form(cfg.endpoints.cat, {id:'c'+Math.random(), nome:c, ts:new Date().toISOString(), del:'false'});
                    });

                    setTimeout(() => { ui.loader(false); sys.init(); }, 2000);
                } catch(e) { alert('Erro ao salvar nuvem: ' + e); ui.loader(false); }
            },

            do_login: async () => {
                const csvLink = document.getElementById('log_csv_link').value;
                const u = document.getElementById('log_user').value;
                const p = document.getElementById('log_pass').value;

                if(!csvLink || !u || !p) return alert('Preencha tudo.');

                ui.loader(true, 'Buscando perfil...');
                
                try {
                    // Fetch Lists CSV to find sys_config
                    const res = await fetch(csvLink + '&t=' + Date.now());
                    const txt = await res.text();
                    const rows = utils.parse_csv(txt);
                    
                    // Find row where ID is sys_config
                    // ID is likely col 0 or 1. Let's look for 'sys_config'
                    let cloudCfg = null;
                    rows.forEach(r => {
                        const idx = r.indexOf('sys_config');
                        if(idx > -1 && r[idx+1]) {
                            // Found it! r[idx+1] should be the JSON
                            try { cloudCfg = JSON.parse(r[idx+1]); } catch(e){}
                        }
                    });

                    if(!cloudCfg) throw new Error('Perfil não encontrado nesta planilha.');

                    // Verify Auth
                    const h = await utils.sha256(p);
                    if(u === cloudCfg.user && h === cloudCfg.pass_hash) {
                        // Success! Update local config
                        localStorage.setItem('lida_config', JSON.stringify(cloudCfg));
                        sessionStorage.setItem('lida_session', 'ok');
                        sys.init();
                    } else {
                        alert('Usuário ou senha inválidos.');
                    }

                } catch(e) {
                    alert('Erro de Login: ' + e.message);
                } finally { ui.loader(false); }
            },

            logout: () => {
                sessionStorage.removeItem('lida_session');
                location.reload();
            },
            
            hard_reset: () => {
                if(confirm('Isso apaga todos os dados locais. Continuar?')) {
                    localStorage.clear();
                    location.reload();
                }
            },

            save_pref: (val) => {
                sys.config.prefs.week_start = val;
                localStorage.setItem('lida_config', JSON.stringify(sys.config));
                // Update Cloud
                const configRow = {
                    id: 'sys_config',
                    nome: JSON.stringify(sys.config),
                    ts: new Date().toISOString(),
                    del: 'false'
                };
                utils.send_form(sys.config.endpoints.cat, configRow);
                app.render();
            }
        };

        // --- 2. DB & LOGIC ---
        const db = {
            data: { local: [], cloud: [], merged: [], cats: [], logs: [] },
            
            load: async () => {
                const ld = localStorage.getItem('lida_data');
                if(ld) db.data.local = JSON.parse(ld);
                await db.sync(true); // Silent sync on load
            },

            sync: async (silent) => {
                if(!silent) ui.loader(true, 'Sincronizando...');
                
                // Save Queue first (if implemented, here simple fire/forget)
                
                try {
                    const ts = Date.now();
                    const [txtRec, txtCat, txtLog] = await Promise.all([
                        fetch(sys.config.endpoints.rec.csv + '&t=' + ts).then(r=>r.text()),
                        fetch(sys.config.endpoints.cat.csv + '&t=' + ts).then(r=>r.text()),
                        fetch(sys.config.endpoints.log.csv + '&t=' + ts).then(r=>r.text())
                    ]);

                    const cRecs = utils.proc_csv(txtRec, 'rec');
                    const cCats = utils.proc_csv(txtCat, 'cat');
                    const cLogs = utils.proc_csv(txtLog, 'log');

                    db.data.cloud = cRecs;
                    db.data.cats = cCats;
                    db.data.logs = cLogs.reverse();

                    // Merge: Local overwrites Cloud if dirty/newer
                    // For V0 simple: 
                    // 1. Mark all Cloud as clean
                    // 2. Override with Local if Local exists
                    // 3. If Local matches Cloud, remove Local (clean)
                    
                    const newLocal = [];
                    db.data.local.forEach(loc => {
                        const cld = cRecs.find(c => c.id === loc.id);
                        if(cld) {
                            // If local ts > cloud ts, keep local
                            if(new Date(loc.ts) > new Date(cld.ts)) newLocal.push(loc);
                        } else {
                            newLocal.push(loc); // Not in cloud yet
                        }
                    });
                    db.data.local = newLocal;
                    
                    db.merge();
                    db.persist();
                    
                } catch(e) { console.log(e); }
                
                if(!silent) ui.loader(false);
                app.render();
                app.render_config();
                app.render_logs();
            },

            merge: () => {
                const m = new Map();
                db.data.cloud.forEach(i => m.set(i.id, i));
                db.data.local.forEach(i => m.set(i.id, {...i, dirty: true})); // Local gets visual flag
                db.data.merged = Array.from(m.values());
            },

            persist: () => {
                localStorage.setItem('lida_data', JSON.stringify(db.data.local));
                db.merge();
            },

            // ACTIONS
            saveItem: () => {
                const id = document.getElementById('e_id').value || 'r' + Date.now();
                const item = {
                    id,
                    titulo: document.getElementById('e_titulo').value,
                    data: document.getElementById('e_data').value,
                    hora: document.getElementById('e_hora').value,
                    valor: document.getElementById('e_valor').value,
                    cat: document.getElementById('e_cat').value,
                    rec: document.getElementById('e_rec').value,
                    status: document.getElementById('e_status').checked ? 'concluido' : 'pendente',
                    det: document.getElementById('e_det').value,
                    ts: new Date().toISOString(),
                    del: 'false',
                    dirty: true
                };
                
                if(!item.titulo || !item.data) return alert('Preencha título e data');

                const idx = db.data.local.findIndex(i => i.id === id);
                if(idx > -1) db.data.local[idx] = item; else db.data.local.push(item);
                
                db.persist();
                ui.closeModal();
                app.render();
                utils.send_form(sys.config.endpoints.rec, item);
            },

            deleteItem: () => {
                const id = document.getElementById('e_id').value;
                if(!id) return;
                const r = db.data.merged.find(i=>i.id===id);
                if(r) {
                    const newItem = {...r, del:'true', ts:new Date().toISOString()};
                    const idx = db.data.local.findIndex(i => i.id === id);
                    if(idx > -1) db.data.local[idx] = newItem; else db.data.local.push(newItem);
                    db.persist();
                    utils.send_form(sys.config.endpoints.rec, newItem);
                }
                ui.closeModal();
                app.render();
            },

            addCat: () => {
                const n = document.getElementById('new_cat_name').value;
                if(!n) return;
                const item = {id:'c'+Date.now(), nome:n, ts:new Date().toISOString(), del:'false'};
                db.data.cats.push(item); // Optimistic UI for Config Screen? No, rely on sync mostly, but push temp
                document.getElementById('new_cat_name').value = '';
                utils.send_form(sys.config.endpoints.cat, item);
                alert('Categoria enviada. Sincronize para atualizar.'); // Simplification
            },
            
            delCat: (id) => {
               const c = db.data.cats.find(i=>i.id===id);
               if(c) { c.del='true'; utils.send_form(sys.config.endpoints.cat, c); alert('Exclusão enviada. Sincronize.'); }
            }
        };

        // --- 3. UI & HELPERS ---
        const app = {
            view: 'dashboard',
            init: () => {
                db.load();
                // Load Prefs
                const ws = sys.config.prefs.week_start;
                document.getElementById('ws_dom').checked = (ws === 0);
                document.getElementById('ws_seg').checked = (ws === 1);
            },
            nav: (v) => {
                app.view = v;
                ui.toggleDrawer(false);
                document.getElementById('page_title').innerText = v.charAt(0).toUpperCase() + v.slice(1);
                
                // Toggle Filter Bar Visibility
                const fBar = document.getElementById('filters_bar');
                const btnF = document.getElementById('btn_filter');
                if(v === 'config' || v === 'logs') {
                    fBar.style.display = 'none'; 
                    btnF.style.display = 'none';
                } else {
                    fBar.style.display = ''; // Restore flex/block via css class logic, simplified here:
                    fBar.classList.remove('open'); // Close initially
                    btnF.style.display = 'block';
                }

                ['view_home','view_config','view_logs'].forEach(x=>document.getElementById(x).classList.add('hidden'));
                
                if(v==='config') { document.getElementById('view_config').classList.remove('hidden'); app.render_config(); }
                else if(v==='logs') { document.getElementById('view_logs').classList.remove('hidden'); app.render_logs(); }
                else {
                    document.getElementById('view_home').classList.remove('hidden');
                    document.getElementById('dash_kpi').style.display = (v === 'dashboard') ? 'grid' : 'none';
                    if(v==='dashboard') document.getElementById('f_period').value = 'hoje';
                    app.render();
                }
            },
            
            render: () => {
                const list = document.getElementById('list_render');
                list.innerHTML = '';
                
                let items = db.data.merged.filter(r => String(r.del) !== 'true');
                
                // Filters
                if(app.view === 'fin') items = items.filter(r => Number(r.valor) > 0);
                if(app.view === 'org') items = items.filter(r => !r.valor || Number(r.valor) === 0);
                
                const term = document.getElementById('f_search').value.toLowerCase();
                if(term) items = items.filter(r => (r.titulo||'').toLowerCase().includes(term));
                
                const cat = document.getElementById('f_cat').value;
                if(cat !== 'todos') items = items.filter(r => r.cat === cat);
                
                const per = document.getElementById('f_period').value;
                const rng = utils.get_date(per, sys.config.prefs.week_start);
                if(rng) items = items.filter(r => {
                    const d = new Date(r.data + 'T12:00:00');
                    return d >= rng.start && d <= rng.end;
                });

                // Sort
                if(app.view==='dashboard') items.sort((a,b) => (a.hora||'').localeCompare(b.hora||''));
                else items.sort((a,b) => (b.data||'').localeCompare(a.data||''));

                // KPI
                let b=0, i=0, o=0, t=0, p=0, k=0;
                items.forEach(r => {
                    const v = Number(r.valor||0);
                    if(v>0) { if(['Trabalhos','Receitas'].includes(r.cat)) {i+=v;b+=v;} else {o+=v;b-=v;} }
                    else { t++; if(r.status==='pendente')p++; else k++; }
                });
                document.getElementById('k_bal').innerText = b.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
                document.getElementById('k_in').innerText = i.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
                document.getElementById('k_out').innerText = o.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
                document.getElementById('k_task').innerText = t; document.getElementById('k_pend').innerText = p; document.getElementById('k_ok').innerText = k;
                document.getElementById('lbl_count').innerText = items.length;

                items.forEach(r => {
                    const v = Number(r.valor||0);
                    const vFmt = v > 0 ? v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) : '';
                    const dt = (r.data||'').split('-').reverse().join('/');
                    const cls = r.dirty ? 'row divergent' : 'row';
                    const chk = r.status === 'concluido' ? 'checked' : '';
                    
                    list.innerHTML += `
                    <div class="${cls}" onclick="app.openModal('${r.id}')">
                        <div class="r-check ${chk}"></div>
                        <div class="r-main"><div class="r-title">${r.titulo}</div><div class="r-meta"><span class="r-tag">${r.cat}</span><span>${dt} ${r.hora||''}</span></div></div>
                        <div class="r-val">${vFmt}</div>
                    </div>`;
                });
            },

            openModal: (id) => {
                if(id) {
                    const r = db.data.merged.find(i=>i.id===id);
                    document.getElementById('e_id').value = r.id;
                    document.getElementById('e_titulo').value = r.titulo;
                    document.getElementById('e_data').value = r.data;
                    document.getElementById('e_hora').value = r.hora;
                    document.getElementById('e_valor').value = r.valor;
                    document.getElementById('e_det').value = r.det;
                    document.getElementById('e_rec').value = r.rec || 'unica';
                    document.getElementById('e_status').checked = (r.status === 'concluido');
                    ui.popCats(r.cat);
                } else {
                    document.getElementById('e_id').value = '';
                    document.getElementById('e_data').value = new Date().toISOString().split('T')[0];
                    document.getElementById('e_titulo').value = '';
                    document.getElementById('e_valor').value = '';
                    document.getElementById('e_hora').value = '';
                    document.getElementById('e_det').value = '';
                    ui.popCats();
                }
                document.getElementById('modal_overlay').classList.remove('hidden');
            },

            render_config: () => {
                const l = document.getElementById('conf_cat_list'); l.innerHTML='';
                const u = [...new Set(db.data.cats.filter(c=>String(c.del)!=='true'&&c.id!=='sys_config').map(c=>c.nome))];
                u.forEach(n => {
                    const id = db.data.cats.find(x=>x.nome===n).id;
                    l.innerHTML += `<div class="row" style="grid-template-columns:1fr auto;"><span>${n}</span><button style="color:red;border:none;background:none;" onclick="db.delCat('${id}')">X</button></div>`;
                });
            },
            
            render_logs: () => {
                const l = document.getElementById('log_list'); l.innerHTML='';
                db.data.logs.slice(0,50).forEach(x => {
                    l.innerHTML += `<div class="log-row"><span>${x.data.replace('T',' ')}</span><span>${x.status}</span></div>`;
                });
            }
        };

        const ui = {
            toggleDrawer: (f) => document.getElementById('drawer').classList.toggle('open'),
            toggleFilters: () => document.getElementById('filters_bar').classList.toggle('open'),
            closeModal: () => document.getElementById('modal_overlay').classList.add('hidden'),
            loader: (s,m) => { const l=document.getElementById('loader'); if(s) { l.style.display='flex'; if(m)l.querySelector('div').innerText=m; } else l.style.display='none'; },
            popCats: (sel) => {
                const s = document.getElementById('e_cat'), f = document.getElementById('f_cat');
                const u = [...new Set(db.data.cats.filter(c=>String(c.del)!=='true'&&c.id!=='sys_config').map(c=>c.nome))];
                s.innerHTML = ''; f.innerHTML = '<option value="todos">Categoria</option>';
                u.forEach(n => {
                    s.innerHTML += `<option ${n===sel?'selected':''}>${n}</option>`;
                    f.innerHTML += `<option>${n}</option>`;
                });
            }
        };

        const utils = {
            sha256: async (s) => {
                const b = new TextEncoder().encode(s);
                const h = await crypto.subtle.digest('SHA-256', b);
                return Array.from(new Uint8Array(h)).map(x => x.toString(16).padStart(2,'0')).join('');
            },
            parse_form_link: (url, map) => {
                try {
                    const base = url.split('/viewform')[0] + '/formResponse';
                    const params = new URLSearchParams(url.split('?')[1]);
                    const entries = {};
                    for (let [k, t] of Object.entries(map)) {
                        params.forEach((v, pk) => { if (v.trim() === t) entries[k] = pk; });
                    }
                    return { base, entries };
                } catch { return null; }
            },
            send_form: async (ep, d) => {
                const fd = new URLSearchParams();
                for(let [k, id] of Object.entries(ep.entries)) { 
                    let v = d[k]; if(v===true)v='True'; if(v===false)v='False'; if(v===undefined)v='';
                    fd.append(id, v);
                }
                await fetch(ep.url, { method: 'POST', mode: 'no-cors', body: fd });
            },
            proc_csv: (txt, type) => {
                const lines = txt.split('\n'), res = [];
                lines.forEach(l => {
                    if(!l.trim()) return;
                    const r = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                    // Detect ID col based on pattern: r... or c... or sys...
                    let idIdx = -1;
                    r.forEach((cell, i) => { if((type==='rec' && /^r\d+/.test(cell)) || (type==='cat' && (/^[cs]\d+|sys_/.test(cell))) || (type==='log' && cell.includes('SUCESSO'))) idIdx = i; });
                    
                    if(idIdx > -1) {
                       if(type==='rec') res.push({id:r[idIdx], titulo:r[idIdx+1], data:r[idIdx+2], hora:r[idIdx+3], valor:r[idIdx+4], cat:r[idIdx+5], rec:r[idIdx+6], status:r[idIdx+7], det:r[idIdx+8], ts:r[idIdx+9], del:r[idIdx+10]});
                       if(type==='cat') res.push({id:r[idIdx], nome:r[idIdx+1], ts:r[idIdx+2], del:r[idIdx+3]});
                    }
                    if(type==='log' && r.length>=3) res.push({status:r[0], data:r[1], agent:r[2]});
                });
                return res;
            },
            get_date: (p, ws) => {
                const h=new Date(); h.setHours(0,0,0,0); const e=new Date(); e.setHours(23,59,59,999);
                const add=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;};
                const stW=(d)=>{const x=new Date(d);const diff=(x.getDay()<ws?7:0)+x.getDay()-ws;x.setDate(x.getDate()-diff);return x;};
                if(p==='hoje') return {start:h,end:e};
                if(p==='ontem') return {start:add(h,-1),end:add(e,-1)};
                if(p==='amanha') return {start:add(h,1),end:add(e,1)};
                if(p==='semana_atual') {const s=stW(h); return {start:s,end:add(s,6)};}
                if(p==='semana_passada') {const s=add(stW(h),-7); return {start:s,end:add(s,6)};}
                if(p==='semana_vem') {const s=add(stW(h),7); return {start:s,end:add(s,6)};}
                if(p==='mes_atual') return {start:new Date(h.getFullYear(),h.getMonth(),1),end:new Date(h.getFullYear(),h.getMonth()+1,0)};
                if(p==='mes_passado') return {start:new Date(h.getFullYear(),h.getMonth()-1,1),end:new Date(h.getFullYear(),h.getMonth(),0)};
                if(p==='mes_vem') return {start:new Date(h.getFullYear(),h.getMonth()+1,1),end:new Date(h.getFullYear(),h.getMonth()+2,0)};
                if(p==='ano_atual') return {start:new Date(h.getFullYear(),0,1),end:new Date(h.getFullYear(),11,31)};
                if(p==='ano_passado') return {start:new Date(h.getFullYear()-1,0,1),end:new Date(h.getFullYear()-1,11,31)};
                if(p==='ano_vem') return {start:new Date(h.getFullYear()+1,0,1),end:new Date(h.getFullYear()+1,11,31)};
                return null;
            }
        };

        window.onload = sys.init;
    </script>
</body>
</html>